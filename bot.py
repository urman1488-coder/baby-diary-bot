import logging
from datetime import datetime
import pytz
import asyncio
from aiogram import Bot, Dispatcher, types, F
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞
BOT_TOKEN = "8547013591:AAF4aeK79jP4Gt7-GFWjcT8_O2KVb4yRKcI"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(
    token=BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()

# –ú–æ—Å–∫–æ–≤—Å–∫–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
MOSCOW_TZ = pytz.timezone('Europe/Moscow')

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –ú–°–ö
def get_moscow_time():
    return datetime.now(MOSCOW_TZ).strftime("%H:%M")

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def get_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [
                KeyboardButton(text="üçº –ö–æ—Ä–º–ª–µ–Ω–∏–µ"),
                KeyboardButton(text="üí© –ü–æ–∫–∞–∫–∞–ª")
            ],
            [
                KeyboardButton(text="üò¥ –°–æ–Ω"),
                KeyboardButton(text="ü§Æ –°—Ä—ã–≥–∏–≤–∞–Ω–∏–µ")
            ],
            [
                KeyboardButton(text="üíä –í–∏—Ç–∞–º–∏–Ω D")
            ]
        ],
        resize_keyboard=True
    )

# –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
async def delete_user_message_safe(chat_id: int, message_id: int, max_retries: int = 3):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏"""
    for attempt in range(max_retries):
        try:
            await bot.delete_message(chat_id, message_id)
            logger.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message_id} —É–¥–∞–ª–µ–Ω–æ")
            return True
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}: –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message_id}. –û—à–∏–±–∫–∞: {e}")
            if attempt < max_retries - 1:
                await asyncio.sleep(2)  # –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
    logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message_id} –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")
    return False

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π - —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
async def handle_user_message(message: types.Message, response_text: str):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –∏ —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥"""
    user_message_id = message.message_id
    chat_id = message.chat.id
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ (–Ω–µ —É–¥–∞–ª—è–µ–º –µ–≥–æ)
    bot_response = await message.answer(response_text)
    
    # –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –∏ –ø—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await asyncio.sleep(10)
    
    # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await delete_user_message_safe(chat_id, user_message_id)

# –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
@dp.message(Command("start", "help"))
async def send_welcome(message: types.Message):
    await handle_user_message(message,
        "üë∂ –î–Ω–µ–≤–Ω–∏–∫ —Ä–µ–±—ë–Ω–∫–∞\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ:\n\n"
        "üçº –ö–æ—Ä–º–ª–µ–Ω–∏–µ\n"
        "üí© –ü–æ–∫–∞–∫–∞–ª\n"  
        "üò¥ –°–æ–Ω\n"
        "ü§Æ –°—Ä—ã–≥–∏–≤–∞–Ω–∏–µ\n"
        "üíä –í–∏—Ç–∞–º–∏–Ω D"
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
@dp.message(F.text == "üçº –ö–æ—Ä–º–ª–µ–Ω–∏–µ")
async def log_feeding(message: types.Message):
    time = get_moscow_time()
    await handle_user_message(message, f"üçº –ö–æ—Ä–º–ª–µ–Ω–∏–µ –≤ {time}")

@dp.message(F.text == "üí© –ü–æ–∫–∞–∫–∞–ª")
async def log_poop(message: types.Message):
    time = get_moscow_time()
    await handle_user_message(message, f"üí© –ü–æ–∫–∞–∫–∞–ª –≤ {time}")

@dp.message(F.text == "üò¥ –°–æ–Ω")
async def log_sleep(message: types.Message):
    time = get_moscow_time()
    await handle_user_message(message, f"üò¥ –°–æ–Ω –≤ {time}")

@dp.message(F.text == "ü§Æ –°—Ä—ã–≥–∏–≤–∞–Ω–∏–µ")
async def log_spitup(message: types.Message):
    time = get_moscow_time()
    await handle_user_message(message, f"ü§Æ –°—Ä—ã–≥–∏–≤–∞–Ω–∏–µ –≤ {time}")

@dp.message(F.text == "üíä –í–∏—Ç–∞–º–∏–Ω D")
async def log_vitamin_d(message: types.Message):
    time = get_moscow_time()
    await handle_user_message(message, f"üíä –í–∏—Ç–∞–º–∏–Ω D –≤ {time}")

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
@dp.message(Command("test"))
async def test_cleanup(message: types.Message):
    await handle_user_message(message, "üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–∏—Ç—Å—è —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥, —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–æ–∫)
@dp.message()
async def other_messages(message: types.Message):
    await handle_user_message(message, 
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏–π.\n\n"
        "–ï—Å–ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start"
    )

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    logger.info("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    await dp.start_polling(bot)

if __name__ == '__main__':
    asyncio.run(main())
